import React from "react";
import { render, screen, cleanup, fireEvent } from "@testing-library/react";
import "@testing-library/jest-dom";
import AppLayout from "./layout";

// Mock next/navigation hooks
jest.mock("next/navigation", () => ({
  usePathname: jest.fn(),
  useRouter: jest.fn(),
}));
const { usePathname, useRouter } = require("next/navigation") as {
  usePathname: jest.Mock;
  useRouter: jest.Mock;
};

// Mock RoleContext
jest.mock("@/context/RoleContext", () => ({ useRole: jest.fn() }));
const { useRole } = require("@/context/RoleContext") as { useRole: jest.Mock };

// Mock TaskContext: TaskProvider should just render children and useTasks is controllable
jest.mock("@/context/TaskContext", () => ({
  TaskProvider: ({ children }: any) => children,
  useTasks: jest.fn(),
}));
const { useTasks } = require("@/context/TaskContext") as { useTasks: jest.Mock };

// Mock ChatbotFloatingButton to a simple marker
jest.mock("@/components/AssistantChat", () => () => <div data-testid="chatbot" />);

beforeEach(() => {
  jest.resetAllMocks();
  cleanup();
});

test("redirects to /login when no user", () => {
  const replace = jest.fn();
  useRole.mockReturnValue({ user: null, role: null, logout: jest.fn() });
  useRouter.mockReturnValue({ replace });
  usePathname.mockReturnValue("/");

  render(
    <AppLayout>
      <div>child</div>
    </AppLayout>
  );

  expect(replace).toHaveBeenCalledWith("/login");
});

test("renders navigation, tasks badge, chatbot and sign out for receptionist", () => {
  const logout = jest.fn();
  useRole.mockReturnValue({ user: { name: "Jay" }, role: "receptionist", logout });
  usePathname.mockReturnValue("/patients");
  useRouter.mockReturnValue({ replace: jest.fn() });
  useTasks.mockReturnValue({
    tasks: [{ id: "t1", completed: false }, { id: "t2", completed: true }],
  });

  render(
    <AppLayout>
      <div>children</div>
    </AppLayout>
  );

  // Signed in display
  expect(screen.getByText(/Signed in as Jay \(receptionist\)/i)).toBeInTheDocument();

  // Patients links (View all + Create new) visible for receptionist
  expect(screen.getByText("View all")).toBeInTheDocument();
  expect(screen.getByText("Create new")).toBeInTheDocument();

  // Appointments links: View all + Create new
  expect(screen.getByText("View all")).toBeInTheDocument();
  expect(screen.getByText("Create new")).toBeInTheDocument();

  // Tasks badge shows open count (1)
  expect(screen.getByText("1")).toBeInTheDocument();

  // Chatbot present for receptionist
  expect(screen.getByTestId("chatbot")).toBeInTheDocument();

  // Sign out button triggers logout
  const signOut = screen.getByRole("button", { name: /Sign out/i });
  fireEvent.click(signOut);
  expect(logout).toHaveBeenCalled();
});

test("officeManager sees Admin and Analytics links and tasks badge", () => {
  useRole.mockReturnValue({ user: { name: "Manager" }, role: "officeManager", logout: jest.fn() });
  usePathname.mockReturnValue("/admin");
  useRouter.mockReturnValue({ replace: jest.fn() });
  useTasks.mockReturnValue({
    tasks: [{ id: "a", completed: false }, { id: "b", completed: false }],
  });

  render(
    <AppLayout>
      <div>content</div>
    </AppLayout>
  );

  // Admin and Analytics links visible
  expect(screen.getByText("Admin")).toBeInTheDocument();
  expect(screen.getByText("Analytics")).toBeInTheDocument();

  // Tasks badge shows count (2)
  expect(screen.getByText("2")).toBeInTheDocument();

  // Chatbot should NOT be rendered for officeManager
  expect(screen.queryByTestId("chatbot")).not.toBeInTheDocument();
});